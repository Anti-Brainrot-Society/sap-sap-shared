name: Publish Package

on:
  push:
    branches: [main]
    paths:
      - '**.ts'
      - 'package.json'
      - 'tsconfig.json'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://npm.pkg.github.com'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Publish
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get published version
        id: version
        run: echo "version=$(node -p 'require("./package.json").version')" >> "$GITHUB_OUTPUT"

  # Notify consumer repos to update their shared dependency.
  # Requires DISPATCH_TOKEN secret: a GitHub PAT with `repo` scope.
  # If the secret is missing, the dispatch step is skipped gracefully.
  notify-consumers:
    needs: publish
    if: success()
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo:
          - Anti-Brainrot-Society/sap-sap-server
          - Anti-Brainrot-Society/sap-sap-mobile
          - Anti-Brainrot-Society/sap-sap-teacher
    steps:
      - name: Dispatch update event
        env:
          DISPATCH_TOKEN: ${{ secrets.DISPATCH_TOKEN }}
          VERSION: ${{ needs.publish.outputs.version }}
          REPO: ${{ matrix.repo }}
        if: env.DISPATCH_TOKEN != ''
        run: |
          curl -f -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $DISPATCH_TOKEN" \
            "https://api.github.com/repos/$REPO/dispatches" \
            -d "{\"event_type\":\"shared-package-updated\",\"client_payload\":{\"version\":\"$VERSION\"}}"
